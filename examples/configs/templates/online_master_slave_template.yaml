# 在线采集 + 3D 定位配置模板（主从触发：master=Software，slaves=Line0/Line1，全字段）
#
# 适用：
# - 你已经在硬件上把 master 的 LineOut 接到了 slaves 的 LineIn
# - 你希望只对 master 下发软触发，由 master 输出线触发 slave
#
# 用法示例：
# - uv run python -m tennis3d.apps.online_mvs_localize --config examples/configs/templates/online_master_slave_template.yaml

# MVS Python 示例绑定目录（MvImport，可选）：
mvimport_dir: ""

# MVS SDK 动态库目录（可选）：
dll_dir: ""

# 注意：serials 的顺序对功能通常不敏感，但建议固定顺序，便于对齐输出与排查问题
serials:
  - "<MASTER_SERIAL>"  # master
  - "<SLAVE1_SERIAL>"  # slave1
  - "<SLAVE2_SERIAL>"  # slave2
  - "<SLAVE3_SERIAL>"  # slave3

calib: <PATH_TO_CALIB_JSON_OR_YAML>

# detector 默认 fake（仅用于链路/冒烟）。真实使用通常改成 pt，并填写 model 路径。
detector: fake
model: ""

min_score: 0.25
require_views: 2

# 多球鲁棒定位参数：
max_detections_per_camera: 10
max_reproj_error_px: 8.0
max_uv_match_dist_px: 25.0
merge_dist_m: 0.08

group_by: frame_num

timeout_ms: 1000
group_timeout_ms: 1000
max_pending_groups: 256
max_groups: 0

# 输出 JSONL（可选）。默认值：不写文件。
# - 置空（""）表示 None
out_jsonl: ""

# 终端输出模式：
# - best：只打印每组 top-1 球（更安静，默认）
# - all：打印该组所有球（便于 debug 多球/误检）
terminal_print_mode: best

# 在线时间轴（默认值：frame_host_timestamp）
time_sync_mode: dev_timestamp_mapping

# 以下为在线滑窗映射参数（均为默认值）。仅在 time_sync_mode=dev_timestamp_mapping 时会用到。
time_mapping_warmup_groups: 20
time_mapping_window_groups: 200
time_mapping_update_every_groups: 5
time_mapping_min_points: 20
time_mapping_hard_outlier_ms: 50.0

trigger:
  # slave 的触发源：常见为 Line0/Line1（取决于你的接线与相机设置）
  trigger_source: Line0

  # master 必须在 serials 列表中
  master_serial: "<MASTER_SERIAL>"

  # 主从触发模式：只对 master 下发软触发
  soft_trigger_fps: 5.0

  # master 输出线设置：把 master 的软触发事件映射到某一路输出线上
  master_line_out: Line1
  master_line_source: ""
  master_line_mode: Output

  trigger_activation: RisingEdge
  trigger_cache_enable: false

# 可选：轨迹拟合后处理（curve v3）。默认 disabled。
curve:
  enabled: false
  primary: v3
  compare_v2: false
  compare_v3_legacy: false
  max_tracks: 4
  association_dist_m: 0.6
  max_missed_s: 0.6
  min_dt_s: 0.000001
  corridor_y_min: 0.6
  corridor_y_max: 1.6
  corridor_y_step: 0.1
  conf_from: quality
  constant_conf: 1.0
  y_offset_m: 0.0
  y_negate: false
  is_bot_fire: -1

  # 观测过滤（默认关闭；要求上游定位输出包含对应诊断字段）
  obs_min_views: 0
  obs_min_quality: 0.0
  obs_max_median_reproj_error_px: null
  obs_max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode_enabled: false
  episode_buffer_s: 0.6
  episode_min_obs: 5
  episode_z_dir: 0
  episode_min_abs_dz_m: 0.25
  episode_min_abs_vz_mps: 1.0
  episode_gravity_mps2: 9.8
  episode_gravity_tol_mps2: 3.0

  # 结束判定
  episode_stationary_speed_mps: 0.25
  episode_end_if_stationary_s: 0.35
  episode_end_after_predicted_land_s: 0.2

  # episode 行为
  reset_predictor_on_episode_start: true
  reset_predictor_on_episode_end: true
  feed_curve_only_when_episode_active: false
