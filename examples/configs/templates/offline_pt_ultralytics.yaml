# 离线 3D 定位配置模板（pt 检测器：Ultralytics YOLOv8 .pt / Windows 友好）
#
# 说明：这是“全字段模板”。字段与 `src/tennis3d/config.py` 完全对齐：
# - 有默认值的字段：写出默认值，方便你了解程序默认行为
# - 必填但没有默认值的字段：使用占位符（<...>），需要你手动替换
#
# 用法示例：
# - uv run python -m tennis3d.apps.offline_localize_from_captures --config examples/configs/templates/offline_pt_ultralytics.yaml

# captures 目录：要求包含 metadata.jsonl（由 python -m mvs.apps.quad_capture 生成）
captures_dir: <PATH_TO_CAPTURES_DIR>

# 标定文件：支持 .json/.yaml/.yml（字段见 examples/configs/templates/calibration_multi_camera.yaml）
calib: <PATH_TO_CALIB_JSON_OR_YAML>

# 可选：只使用指定相机序列号（serial）参与检测/定位。
# - 不写：默认使用 captures 中出现的全部相机。
# - 3D 定位至少需要 2 路视角，且 serials 数量必须 >= require_views。
# serials:
#   - DA8199303
#   - DA8199402

# 检测器后端：fake|color|rknn|pt
# Windows 上推荐 pt（不依赖 rknn 运行时）。
detector: pt

# detector=pt 时必填（.pt）。建议使用相对路径，方便项目搬迁。
model: <PATH_TO_MODEL_PT>

min_score: 0.25
require_views: 2

# 多球鲁棒定位参数：
max_detections_per_camera: 10
max_reproj_error_px: 8.0
max_uv_match_dist_px: 25.0
merge_dist_m: 0.08

max_groups: 0

# 输出 JSONL 路径（每行一个结果记录）。默认值如下：
out_jsonl: data/tools_output/offline_positions_3d.jsonl

# 时间轴（默认值：frame_host_timestamp）：
# - frame_host_timestamp：沿用原逻辑，用组内 frames[*].host_timestamp 中位数作为 capture_t_abs
# - dev_timestamp_mapping：使用预先拟合的 dev_timestamp -> host_ms 映射，把组时间贴近曝光时刻
time_sync_mode: frame_host_timestamp

# 可选：映射文件路径。
# - 仅在 time_sync_mode=dev_timestamp_mapping 时生效
# - 为空表示使用默认路径：<captures_dir>/time_mapping_dev_to_host_ms.json
time_mapping_path: ""

# 可选：轨迹拟合后处理（curve v3）。默认 disabled。
curve:
  enabled: false
  primary: v3
  compare_v2: false
  compare_v3_legacy: false
  max_tracks: 4
  association_dist_m: 0.6
  max_missed_s: 0.6
  min_dt_s: 0.000001
  corridor_y_min: 0.6
  corridor_y_max: 1.6
  corridor_y_step: 0.1
  conf_from: quality
  constant_conf: 1.0
  y_offset_m: 0.0
  y_negate: false
  is_bot_fire: -1

  # 观测过滤（默认关闭；要求上游定位输出包含对应诊断字段）
  obs_min_views: 0
  obs_min_quality: 0.0
  obs_max_median_reproj_error_px: null
  obs_max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode_enabled: false
  episode_buffer_s: 0.6
  episode_min_obs: 5
  episode_z_dir: 0
  episode_min_abs_dz_m: 0.25
  episode_min_abs_vz_mps: 1.0
  episode_gravity_mps2: 9.8
  episode_gravity_tol_mps2: 3.0

  # 结束判定
  episode_stationary_speed_mps: 0.25
  episode_end_if_stationary_s: 0.35
  episode_end_after_predicted_land_s: 0.2

  # episode 行为
  reset_predictor_on_episode_start: true
  reset_predictor_on_episode_end: true
  feed_curve_only_when_episode_active: false
