# 离线 3D 定位配置（Windows/CPU，使用你归档的四相机内外参）
#
# 用法示例（任选其一）：
# - uv run python -m tennis3d.apps.offline_localize_from_captures --config configs/offline_pt_windows_cpu_params_4cam.yaml
# - tennis3d-offline --config configs/offline_pt_windows_cpu_params_4cam.yaml

# captures 目录：要求包含 metadata.jsonl，且其中 frames.file 指向实际图片。
captures_dir: data/captures_master_slave/tennis_offline

# 方案B：用 dev_timestamp -> host 时间轴映射生成 capture_t_abs（更贴近曝光时刻）。
# - frame_host_timestamp：默认方案，用组内 host_timestamp 中位数
# - dev_timestamp_mapping：启用映射（需要先生成 time_mapping_dev_to_host_ms.json）
time_sync_mode: dev_timestamp_mapping

# 可选：映射文件路径。不填则默认使用 <captures_dir>/time_mapping_dev_to_host_ms.json
# time_mapping_path: data/captures_master_slave/tennis_offline/time_mapping_dev_to_host_ms.json

# 标定文件：由 data/calibration/inputs/2026-01-30/*.json 融合生成（单位：m）
calib: data/calibration/camera_extrinsics_C_T_B.json

# - pixel_format 为空表示不设置（沿用相机当前配置）。
# - image_width/image_height 必须同时设置；不设置就删掉/留空。
pixel_format: BayerRG8
image_width: 1980
image_height: 1080
image_offset_x: 200
image_offset_y: 400

# 可选：只使用指定相机序列号（serial）参与检测/定位。
# 建议显式写出来，避免输入数据 camera_name 与标定 key 不一致导致相机被静默跳过。
serials:
  - DA8199303
  - DA8199402
  - DA8199243
  - DA8199285

# 检测器后端：fake|color|rknn|pt
# Windows 上通常使用 pt（不依赖 rknn 运行时）。
detector: pt

# 模型路径：detector=pt 时必填（.pt）
model: data/models/best.pt

# 置信度阈值：会传给 detector，同时也会作为 pipeline 的 min_score
min_score: 0.20

# 至少需要几路相机同时检测到球，才会做三角化输出 3D
require_views: 2

# 多球鲁棒定位参数：
max_detections_per_camera: 10
max_reproj_error_px: 10.0
max_uv_match_dist_px: 25.0
merge_dist_m: 0.08

# 最多处理多少个 group（0 表示不限）
max_groups: 0

curve:
  enabled: true
  primary: v3
  compare_v2: false
  compare_v3_legacy: false
  max_tracks: 4
  association_dist_m: 2.0
  max_missed_s: 0.6
  min_dt_s: 0.000001
  # corridor_y_min: 0.6
  # corridor_y_max: 1.2
  corridor_y_min: 0.9
  corridor_y_max: 1.0
  corridor_y_step: 0.1
  conf_from: quality
  constant_conf: 1.0
  y_offset_m: 0.0
  y_negate: false
  is_bot_fire: -1

  # 观测过滤（默认关闭；需要上游定位输出包含对应诊断字段）
  obs_min_views: 0
  obs_min_quality: 0.0
  obs_max_median_reproj_error_px: null
  obs_max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode_enabled: false
  episode_buffer_s: 0.6
  episode_min_obs: 5
  episode_z_dir: 0
  episode_min_abs_dz_m: 0.25
  episode_min_abs_vz_mps: 1.0
  episode_gravity_mps2: 9.8
  episode_gravity_tol_mps2: 3.0

  # 结束判定
  episode_stationary_speed_mps: 0.25
  episode_end_if_stationary_s: 0.35
  episode_end_after_predicted_land_s: 0.2

  # episode 行为
  reset_predictor_on_episode_start: true
  reset_predictor_on_episode_end: true
  feed_curve_only_when_episode_active: false

# 输出 JSONL 路径（每行一个结果记录）
out_jsonl: data/tools_output/offline_positions_3d.params_4cam.jsonl
